import{a as j,b as C,c as $,d as q,e as Q,f as U,g as W,j as Y,l as H,m as J,n as K,o as X,p as Z}from"./chunk-OEYWFVJR.js";import{a as z}from"./chunk-I5YVCZWU.js";import{Ba as N,Da as L,Ea as R,G as f,Ga as w,H as h,Ha as A,I as x,Ia as B,K as P,L as b,M as y,N as o,O as n,P as s,T as g,V as u,X as _,Y as S,Z as k,_ as O,ba as c,ca as V,da as T,n as m,o as p,ra as I,u as D,v as d,wa as G,x as v,y as M}from"./chunk-54XO3K6U.js";function F(a){let t=a.value;if(!t)return null;if(!/^\d{4}-(0[1-9]|1[0-2])-(0[1-9]|[12]\d|3[01])$/.test(t))return{formatoInvalido:!0};let[e,r,i]=t.split("-").map(Number),l=[31,28,31,30,31,30,31,31,30,31,30,31];return(e%4===0&&e%100!==0||e%400===0)&&(l[1]=29),i>l[r-1]?{fechaInvalida:!0}:null}var te=["endDateInput"],ie=["startDateInput"];function ne(a,t){a&1&&(o(0,"div",4),s(1,"app-box-loader"),n())}function re(a,t){if(a&1){let e=g();o(0,"div",17)(1,"div",31),u("click",function(){m(e);let i=_();return p(i.onChangePromotionType(!1))}),o(2,"p"),c(3,"Por producto y categor\xEDa"),n()(),o(4,"div",31),u("click",function(){m(e);let i=_();return p(i.onChangePromotionType(!0))}),o(5,"p"),c(6,"General (toda la tienda)"),n()()()}}function oe(a,t){a&1&&s(0,"img",36)}function ae(a,t){if(a&1){let e=g();o(0,"div",31),u("click",function(){m(e);let i=_(3);return p(i.general=!1)})("click",function(){let i=m(e).$implicit,l=_(3);return p(l.onSelectCat(i))}),o(1,"p"),c(2),n(),f(3,oe,1,0,"img",36),n()}if(a&2){let e=t.$implicit,r=_(3);d(2),V(e.nombre),d(),h(e.id in r.selectedCat?3:-1)}}function le(a,t){if(a&1&&(o(0,"div",17),P(1,ae,4,2,"div",35,x),n()),a&2){let e=_(2);d(),b(e.categories)}}function se(a,t){if(a&1){let e=g();o(0,"div",33)(1,"div",37)(2,"p"),c(3),n()(),o(4,"img",38),u("click",function(){let i=m(e).$implicit,l=_(2);return p(l.onRemoveCat(i))}),n()()}if(a&2){let e=t.$implicit;d(3),V(e.nombre)}}function de(a,t){a&1&&s(0,"img",43)}function ce(a,t){if(a&1){let e=g();o(0,"div",31),u("click",function(i){let l=m(e).$implicit,E=_(4);return i.stopPropagation(),p(E.slelectProd(l))}),o(1,"div",41),s(2,"img",42),n(),o(3,"p"),c(4),n(),f(5,de,1,0,"img",43),n()}if(a&2){let e=t.$implicit,r=_().$implicit,i=_(3);d(2),y("src",e.image,D),d(2),V(r.name),d(),h(e.id in i.selectedVariants?5:-1)}}function me(a,t){if(a&1&&P(0,ce,6,3,"div",35,x),a&2){let e=t.$implicit;b(e.variants)}}function pe(a,t){if(a&1){let e=g();o(0,"div",34)(1,"div",35)(2,"div",15),u("click",function(i){return m(e),p(i.stopPropagation())}),o(3,"img",39),u("click",function(){m(e);let i=_(2);return p(i.onSearch())}),n(),o(4,"input",40,2),u("keydown.enter",function(){m(e);let i=_(2);return p(i.onSearch())}),n()()(),P(6,me,2,0,null,null,x),n()}if(a&2){let e=_(2);d(6),b(e.filteredProd)}}function ue(a,t){if(a&1){let e=g();o(0,"div",33)(1,"div",37)(2,"div",41),s(3,"img",42),n(),o(4,"p"),c(5),n()(),o(6,"img",38),u("click",function(){let i=m(e).$implicit,l=_(2);return p(l.removeSelected(i.id))}),n()()}if(a&2){let e=t.$implicit;d(3),y("src",e.image,D),d(2),V(e.genericProd==null?null:e.genericProd.name)}}function _e(a,t){if(a&1){let e=g();o(0,"div",7)(1,"label",8),c(2,"Categor\xEDas"),n(),o(3,"div",32)(4,"div",15),u("click",function(){m(e);let i=_();return p(i.openCatOption=!i.openCatOption)}),o(5,"label",8),c(6,"Selecciona las categor\xEDas para esta promoci\xF3n"),n(),s(7,"img",16),f(8,le,3,0,"div",17),n(),P(9,se,5,1,"div",33,x),n(),s(11,"div",11),n(),o(12,"div",7)(13,"label",8),c(14,"Productos"),n(),o(15,"div",32)(16,"div",15),u("click",function(){m(e);let i=_();return p(i.onOpenSelProd())}),o(17,"label",8),c(18,"Selecciona las productos para esta promoci\xF3n"),n(),s(19,"img",16),f(20,pe,8,0,"div",34),n(),P(21,ue,7,2,"div",33,x),n(),s(23,"div",11),n()}if(a&2){let e=_();d(8),h(e.openCatOption?8:-1),d(),b(e.getCategories()),d(11),h(e.openProdOption?20:-1),d(),b(e.getVariants())}}var ee=class a{constructor(t,e,r,i,l,E){this.fb=t;this.cdr=e;this.http=r;this.router=i;this.route=l;this.errorServ=E;this.createForm=t.group({name:["",[C.required]],description:["",[C.required,C.maxLength(500)]],discount:[0,[C.required,C.min(.01)]],startDate:["",[C.required,F]],endDate:["",[C.required,F]],search:[""]})}createForm;endDateInput;startDateInput;loading=!1;general=!1;openTypeOption=!1;openCatOption=!1;openProdOption=!1;products=[];categories=[];selectedCat={};selectedVariants={};filteredProd=[];edit;ngOnInit(){this.createForm.get("search")?.valueChanges.subscribe(e=>{this.filteredProd=this.products.filter(r=>this.match(r.name,e))}),this.loadData();let t=this.route.snapshot.queryParamMap.get("edit");t&&this.loadPromo(t)}loadPromo(t){this.http.getPromotion(t).subscribe({next:e=>{this.edit=e;let r=new Date(this.edit.startDate);console.log(r);let i=new Date(this.edit.endDate);this.createForm.setValue({name:this.edit.name,description:this.edit.description,discount:this.edit.discount,startDate:this.convertToDate(r),endDate:this.convertToDate(i),search:[""]}),this.general=this.edit.Type=="General",console.log(e),this.edit.products.forEach(l=>this.selectedVariants[l.productId]=l.product),this.edit.categories.forEach(l=>this.selectedCat[l.categoryId]=l.category),this.cdr.detectChanges()},error:e=>{this.errorServ.addError(w(e))}})}ngAfterViewInit(){this.endDateInput.nativeElement.addEventListener("change",t=>{this.createForm.get("endDate")?.setValue(t.target.value.toString())}),this.startDateInput.nativeElement.addEventListener("change",t=>{this.createForm.get("startDate")?.setValue(t.target.value.toString())})}loadData(){this.loading=!0,this.http.getCategories().subscribe({next:t=>{this.categories=t,this.loadProd()},error:t=>{this.loading=!1,this.cdr.detectChanges(),this.errorServ.addError(w(t))}})}loadProd(){this.http.getProducts().subscribe({next:t=>{this.products=t,this.filteredProd=this.products,this.loading=!1,this.cdr.detectChanges()},error:t=>{this.loading=!1,this.cdr.detectChanges(),this.errorServ.addError(w(t))}})}pickDate(t){t==="startDate"?this.startDateInput.nativeElement.showPicker():this.endDateInput.nativeElement.showPicker()}increment(t){let e=this.createForm.value.discount+t;e<0||this.createForm.get("discount")?.setValue(e)}onSubmit(){if(this.valid()){let t=this.crearFechaConOffsetLocal(this.createForm.get("startDate")?.value),e=this.crearFechaConOffsetLocal(this.createForm.get("endDate")?.value),r={startDate:t,endDate:e,name:this.createForm.value.name,discountType:"percent",Type:this.general?"General":"Por producto y categor\xEDa",categories:this.getCategories().map(i=>i.id),products:this.getVariants().map(i=>i.id),discount:this.createForm.value.discount,description:this.createForm.value.description};if(this.edit){this.loading=!0,this.http.updatePromo(this.edit.promo_id,r).subscribe({next:i=>{this.loading=!1,this.router.navigate(["dashboard/promotions"])},error:i=>{this.loading=!1,this.errorServ.addError(w(i))}});return}this.loading=!0,this.http.createPromo(r).subscribe({next:i=>{this.loading=!1,this.router.navigate(["dashboard/promotions"])},error:i=>{this.loading=!1,this.errorServ.addError(w(i))}})}}onSearch(){}slelectProd(t){this.selectedVariants[t.id]=t}getVariants(){return Object.values(this.selectedVariants)}getCategories(){return Object.values(this.selectedCat)}removeSelected(t){delete this.selectedVariants[t]}valid(){return this.createForm.valid&&this.getVariants().length>0}onSelectCat(t){this.selectedCat[t.id]=t,this.products.forEach(e=>{(e.category.id=t.id)&&e.variants.forEach(r=>this.selectedVariants[r.id]=r)})}onRemoveCat(t){delete this.selectedCat[t.id],this.getVariants().forEach(e=>{(e.genericProd.category.id=t.id)&&(delete this.selectedVariants[e.id],this.cdr.detectChanges())})}onChangePromotionType(t){this.general=t,this.selectedCat={},this.selectedVariants={},t&&this.products.forEach(e=>e.variants.forEach(r=>this.selectedVariants[r.id]=r))}onOpenSelProd(){this.openProdOption=!this.openProdOption}onSearhValue(t){console.log("Valor cambiado:",t)}match(t,e){return t=t.normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase(),e=e.normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase(),t.match(e)}crearFechaConOffsetLocal(t){let[e,r,i]=t.split("-").map(Number);return new Date(e,r-1,i,12,0,0)}convertToDate(t){let e=t.getFullYear().toString(),r=(t.getMonth()+1+100).toString().slice(1),i=(t.getDate()+100).toString().slice(1);return e+"-"+r+"-"+i}static \u0275fac=function(e){return new(e||a)(v(X),v(I),v(A),v(L),v(N),v(B))};static \u0275cmp=M({type:a,selectors:[["app-create-promotion"]],viewQuery:function(e,r){if(e&1&&(S(te,5),S(ie,5)),e&2){let i;k(i=O())&&(r.endDateInput=i.first),k(i=O())&&(r.startDateInput=i.first)}},decls:69,vars:8,consts:[["startDateInput",""],["endDateInput",""],["searchProd",""],[1,"main"],[1,"loader-wrapper"],[1,"header"],[1,"create-form",3,"submit","formGroup"],[1,"form-text"],["for",""],[1,"input-base"],["type","text","formControlName","name"],[1,"line"],[1,"input-container"],["type","text","formControlName","description","maxlength","500"],[1,"count"],[1,"input-base",3,"click"],["src","chevron-down.svg","alt",""],[1,"dialog"],[1,"discount"],[1,"disc-btn",3,"click"],["src","plus-black.svg","alt",""],[1,"discount-txt"],["type","number","formControlName","discount"],["src","minus.svg","alt",""],["src","calendar.svg","alt","",3,"click"],["type","text","id","startDate","formControlName","startDate","placeholder","aaaa-mm-dd","pattern","\\d{4}-\\d{2}-\\d{2}","required",""],["type","date","id",""],["type","text","id","endDate","formControlName","endDate","placeholder","aaaa-mm-dd"],[1,"form-footer"],["type","button",1,"button-chips",3,"routerLink"],["type","submit",1,"button-base",3,"disabled"],[1,"dialog-item",3,"click"],[1,"selection"],[1,"input-base","propierty"],[1,"dialog","products"],[1,"dialog-item"],["src","check.svg"],[1,"finish-data"],["src","divide-circle.svg","alt","delete",1,"delete",3,"click"],["src","search.svg","alt","",3,"click"],["type","text","formControlName","search","placeholder","Buscar",3,"keydown.enter"],[1,"image"],["alt","",3,"src"],["src","check.svg","alt",""]],template:function(e,r){if(e&1){let i=g();o(0,"div",3),f(1,ne,2,0,"div",4),o(2,"header",5)(3,"h1"),c(4,"Promociones"),n()(),o(5,"form",6),u("submit",function(){return m(i),p(r.onSubmit())}),o(6,"div",7)(7,"label",8),c(8,"Nombre"),n(),o(9,"div",9),s(10,"input",10),n(),s(11,"div",11),n(),o(12,"div",7)(13,"label",8),c(14,"Descripci\xF3n breve"),n(),o(15,"div",12)(16,"div",9),s(17,"textarea",13),n(),o(18,"span",14),c(19),n()(),s(20,"div",11),n(),o(21,"div",7)(22,"label",8),c(23,"Tipo de promoci\xF3n"),n(),o(24,"div",15),u("click",function(){return m(i),p(r.openTypeOption=!r.openTypeOption)}),o(25,"label",8),c(26),n(),s(27,"img",16),f(28,re,7,0,"div",17),n(),s(29,"div",11),n(),o(30,"div",7)(31,"label",8),c(32,"Valor del descuento"),n(),o(33,"div",18)(34,"div",19),u("click",function(){return m(i),p(r.increment(1))}),s(35,"img",20),n(),o(36,"div",21),s(37,"input",22),o(38,"span"),c(39,"%"),n()(),o(40,"div",19),u("click",function(){return m(i),p(r.increment(-1))}),s(41,"img",23),n()(),s(42,"div",11),n(),o(43,"div",7)(44,"label",8),c(45,"Fecha de inicio"),n(),o(46,"div",9)(47,"img",24),u("click",function(){return m(i),p(r.pickDate("startDate"))}),n(),s(48,"input",25)(49,"input",26,0),n(),s(51,"div",11),n(),o(52,"div",7)(53,"label",8),c(54,"Fecha de finalizaci\xF3n"),n(),o(55,"div",9)(56,"img",24),u("click",function(){return m(i),p(r.pickDate("endDate"))}),n(),s(57,"input",27)(58,"input",26,1),n(),s(60,"div",11),n(),f(61,_e,24,2),o(62,"footer",28)(63,"button",29)(64,"span"),c(65,"Cancelar"),n()(),o(66,"button",30)(67,"span"),c(68,"Guardar"),n()()()()()}e&2&&(d(),h(r.loading?1:-1),d(4),y("formGroup",r.createForm),d(14),T("",r.createForm.value.description.length,"/500"),d(7),V(r.general?"General (toda la tienda)":"Por producto y categor\xEDa"),d(2),h(r.openTypeOption?28:-1),d(33),h(r.general?-1:61),d(2),y("routerLink","/dashboard/promotions"),d(3),y("disabled",!r.valid()))},dependencies:[Z,Q,j,U,$,q,H,J,K,W,Y,G,z,R],styles:[".main[_ngcontent-%COMP%]{display:flex;flex-direction:column;gap:32px;position:relative}.header[_ngcontent-%COMP%]{display:flex;align-items:center;justify-content:space-between;padding-inline:32px}h1[_ngcontent-%COMP%]{color:var(--Gray-900, #181D27);font-family:var(--montser-font);font-size:30px;font-style:normal;font-weight:600;line-height:38px;margin:0}.form-text[_ngcontent-%COMP%]{display:flex;gap:32px;position:relative;margin-bottom:20px}.form-text[_ngcontent-%COMP%]   label[_ngcontent-%COMP%]{width:360px;color:var(--Gray-700, #414651);font-family:var(--montser-font);font-size:14px;font-style:normal;font-weight:600;line-height:20px}.input-base[_ngcontent-%COMP%]{width:512px;box-sizing:border-box}.create-form[_ngcontent-%COMP%]{display:flex;flex-direction:column;gap:20px;padding-inline:32px}textarea[_ngcontent-%COMP%]{field-sizing:content;resize:none}.line[_ngcontent-%COMP%]{position:absolute;width:100%;bottom:-20px;height:1px;align-self:stretch;background:var(--Gray-200, #E9EAEB)}.count[_ngcontent-%COMP%]{color:var(--Gray-600, #535862);font-family:var(--montser-font);font-size:14px;font-style:normal;font-weight:400;line-height:20px}.input-base[_ngcontent-%COMP%]   label[_ngcontent-%COMP%], .input-base[_ngcontent-%COMP%]   span[_ngcontent-%COMP%]{display:flex;flex:1;color:var(--Gray-500, #717680);font-family:var(--montser-font);font-size:16px;font-style:normal;font-weight:400;line-height:24px}.disc-btn[_ngcontent-%COMP%]{display:flex;padding:10px;cursor:pointer}.disc-btn[_ngcontent-%COMP%]   [_ngcontent-%COMP%]:hover{cursor:pointer}.discount[_ngcontent-%COMP%]{display:flex;width:170px;border-radius:8px;border:1px solid var(--Gray-300, #D5D7DA);background:var(--White, #FFF);overflow:hidden}.discount-txt[_ngcontent-%COMP%]{display:flex;padding:10px;flex:1;align-items:center;gap:10px;background:var(--Gray-50, #FAFAFA);border-inline:1px solid #D5D7DA}.discount-txt[_ngcontent-%COMP%]   span[_ngcontent-%COMP%]{color:var(--Gray-800, #252B37);font-family:var(--montser-font);font-size:14px;font-style:normal;font-weight:500;line-height:20px}input[type=number][_ngcontent-%COMP%]::-webkit-inner-spin-button, input[type=number][_ngcontent-%COMP%]::-webkit-outer-spin-button{-webkit-appearance:none;margin:0}input[type=number][_ngcontent-%COMP%]{background-color:#fafafa;text-align:right;width:40px}input[type=date][_ngcontent-%COMP%]{opacity:0;position:absolute;pointer-events:none}.input-base[_ngcontent-%COMP%]{position:relative}.image[_ngcontent-%COMP%]{position:relative;height:40px;aspect-ratio:1;overflow:hidden}.image[_ngcontent-%COMP%]   img[_ngcontent-%COMP%]{width:100%;height:100%;object-fit:cover;justify-self:center}.dialog.products[_ngcontent-%COMP%]{overflow:auto;max-height:600px}.input-base.propierty[_ngcontent-%COMP%]{border-color:#279ea8}.finish-data[_ngcontent-%COMP%]{display:flex;gap:16px;align-items:center;flex:1}.finish-data[_ngcontent-%COMP%]   p[_ngcontent-%COMP%]{margin:0;color:var(--Gray-700, #414651);font-family:var(--montser-font);font-size:14px;font-style:normal;font-weight:500;line-height:20px}.avatar[_ngcontent-%COMP%]{display:flex;width:28px;height:28px;flex-direction:column;justify-content:center;align-items:center;border-radius:50%;overflow:hidden}.avatar[_ngcontent-%COMP%]   img[_ngcontent-%COMP%]{height:100%}.selection[_ngcontent-%COMP%]{display:flex;flex-direction:column;gap:16px}.form-footer[_ngcontent-%COMP%]{display:flex;justify-content:end;gap:12px}.delete[_ngcontent-%COMP%]{cursor:pointer}"]})};export{ee as CreatePromotion};
